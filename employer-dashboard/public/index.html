<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employer Benefits Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #2563eb; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2em; font-weight: bold; color: #2563eb; }
        .stat-label { color: #666; margin-top: 5px; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section h2 { color: #333; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        .status { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; }
        .status.pending { background: #f59e0b; }
        .status.approved { background: #10b981; }
        .status.rejected { background: #ef4444; }
        .btn { background: #2563eb; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #1d4ed8; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>Employer Benefits Dashboard</h1>
                <p>Manage employee claims and track benefit fund usage</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span id="userInfo" style="color: white; font-size: 14px;"></span>
                <button onclick="logout()" class="btn" style="width: auto; padding: 8px 16px; font-size: 14px;">
                    Logout
                </button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="loading">Loading dashboard statistics...</div>
        </div>

        <div class="section">
            <h2>Recent Claims</h2>
            <div id="claimsTable">
                <div class="loading">Loading claims data...</div>
            </div>
        </div>

        <div class="section">
            <h2>Submit New Claim</h2>
            <form id="claimForm">
                <div class="form-group">
                    <label for="employeeSelect">Employee:</label>
                    <select id="employeeSelect" required>
                        <option value="">Select Employee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="provider">Provider:</label>
                    <input type="text" id="provider" required placeholder="e.g., Nairobi Hospital">
                </div>
                <div class="form-group">
                    <label for="category">Category:</label>
                    <select id="category" required>
                        <option value="">Select Category</option>
                        <option value="medical">Medical</option>
                        <option value="dental">Dental</option>
                        <option value="vision">Vision</option>
                        <option value="wellness">Wellness</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amount">Amount (KES):</label>
                    <input type="number" id="amount" required step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="justification">Justification:</label>
                    <input type="text" id="justification" placeholder="Brief description of the claim">
                </div>
                <button type="submit" class="btn">Submit Claim</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let currentUser = null;

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/user`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('userInfo').textContent = `Welcome, ${currentUser.email}`;
                    return true;
                } else {
                    // Not authenticated, redirect to login
                    window.location.href = '/login.html';
                    return false;
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/login.html';
                return false;
            }
        }

        // Logout function
        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login.html';
            }
        }
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load statistics
                const statsResponse = await fetch(`${API_BASE}/analytics/dashboard`, {
                    credentials: 'include'
                });
                const stats = await statsResponse.json();
                
                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalEmployers}</div>
                        <div class="stat-label">Employers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalEmployees}</div>
                        <div class="stat-label">Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalClaims}</div>
                        <div class="stat-label">Total Claims</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.pendingClaims}</div>
                        <div class="stat-label">Pending Claims</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">KES ${stats.totalPaidOut.toLocaleString()}</div>
                        <div class="stat-label">Total Paid Out</div>
                    </div>
                `;

                // Load employers and employees for form
                const employersResponse = await fetch(`${API_BASE}/employers`, {
                    credentials: 'include'
                });
                const employers = await employersResponse.json();
                
                let employeeOptions = '<option value="">Select Employee</option>';
                employers.forEach(employer => {
                    employer.employees.forEach(employee => {
                        employeeOptions += `<option value="${employee.id}">${employee.name} (${employer.name})</option>`;
                    });
                });
                document.getElementById('employeeSelect').innerHTML = employeeOptions;

                // Load claims table
                await loadClaims();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('statsGrid').innerHTML = '<div class="loading">Error loading statistics</div>';
            }
        }

        async function loadClaims() {
            try {
                const employersResponse = await fetch(`${API_BASE}/employers`, {
                    credentials: 'include'
                });
                const employers = await employersResponse.json();
                
                let allClaims = [];
                employers.forEach(employer => {
                    employer.employees.forEach(employee => {
                        employee.claims.forEach(claim => {
                            allClaims.push({
                                ...claim,
                                employeeName: employee.name,
                                employerName: employer.name
                            });
                        });
                    });
                });

                // Sort by creation date (newest first)
                allClaims.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                let claimsHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Employer</th>
                                <th>Provider</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                allClaims.forEach(claim => {
                    claimsHTML += `
                        <tr>
                            <td>${claim.employeeName}</td>
                            <td>${claim.employerName}</td>
                            <td>${claim.provider}</td>
                            <td>${claim.category}</td>
                            <td>KES ${claim.amount.toLocaleString()}</td>
                            <td><span class="status ${claim.status}">${claim.status}</span></td>
                            <td>${new Date(claim.createdAt).toLocaleDateString()}</td>
                            <td>
                                ${claim.status === 'pending' ? 
                                    `<button class="btn" onclick="updateClaimStatus('${claim.id}', 'approved')">Approve</button>
                                     <button class="btn" onclick="updateClaimStatus('${claim.id}', 'rejected')">Reject</button>` 
                                    : 'N/A'}
                            </td>
                        </tr>
                    `;
                });

                claimsHTML += '</tbody></table>';
                document.getElementById('claimsTable').innerHTML = claimsHTML;

            } catch (error) {
                console.error('Error loading claims:', error);
                document.getElementById('claimsTable').innerHTML = '<div class="loading">Error loading claims</div>';
            }
        }

        async function updateClaimStatus(claimId, status) {
            try {
                await fetch(`${API_BASE}/claims/${claimId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status })
                });
                
                // Reload dashboard
                loadDashboard();
                alert(`Claim ${status} successfully`);
            } catch (error) {
                console.error('Error updating claim:', error);
                alert('Error updating claim status');
            }
        }

        // Handle form submission
        document.getElementById('claimForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const formData = {
                    employeeId: document.getElementById('employeeSelect').value,
                    provider: document.getElementById('provider').value,
                    category: document.getElementById('category').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    justification: document.getElementById('justification').value
                };

                await fetch(`${API_BASE}/claims`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                // Reset form and reload data
                document.getElementById('claimForm').reset();
                loadDashboard();
                alert('Claim submitted successfully');

            } catch (error) {
                console.error('Error submitting claim:', error);
                alert('Error submitting claim');
            }
        });

        // Initialize app
        async function initApp() {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadDashboard();
            }
        }

        // Load dashboard on page load
        initApp();
    </script>
</body>
</html>